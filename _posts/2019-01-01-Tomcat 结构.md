# Tomcat 结构

Tomcat版本:8.5.50 , 下载地址: [tomcat 下载](https://tomcat.apache.org/download-80.cgi) .

Tomcat过于复杂，总结难免出错，请根据自己的实际理解进行验证. 

## 整体结构
整体结构图(根据线上部署稍有删减)

![image.png](https://cdn.nlark.com/yuque/0/2019/png/191132/1577801950084-b48009a3-f9c9-4594-9209-fbf1669157fb.png#align=left&display=inline&height=519&name=image.png&originHeight=1054&originWidth=1516&size=203733&status=done&style=shadow&width=746)

- **Tomcat:** 作为一个Http服务器对外提供web服务.
- **Server:** Servlet 容器，会包含多个Service(实际线上部署只有一个Service) , 默认实现是 **StandardServer**.
- **Service: **主要由多个Connector(处理即将到来的 **Http(http请求为例) **请求)+Engine组成.
- **Connector:** 解析并且处理http请求，转发到CoyoteAdapter.
- **Engine:** Catalina servlet 引擎，直接子容器是Context , 每一个Service都只有一个.
- **Context:** 代表了一个web应用，线上就是一个Context., 标准实现是 **StandardContext**.

**
Loader 是**Context**的(类)加载器，负载加载Context下边的 **WEB-INF/class**和**WEB-INF/lib**下边的文件.
WebResourceRoot是Resource的一层抽象，主要是维护并读取**WEB-INF/class**和**WEB-INF/lib**下边的文件.

> Container(容器)的概念是在Engine处才开始体现的，从代码来看就是看有没有实现Container接口

**
## **UML图例**
**
如果不支持看大图，可以复制图片地址到浏览器看大图
**
![](https://cdn.nlark.com/yuque/__puml/f44eab1e34b4fa13e6ee24a49b146ca1.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbmludGVyZmFjZSBMaWZlY3ljbGUge1xuICArdm9pZCBpbml0KClcblx0K3ZvaWQgc3RhcnQoKVxuXHQrTGlmZWN5Y2xlU3RhdGUgZ2V0U3RhdGUoKVxufVxuXG5hYnN0cmFjdCBjbGFzcyBMaWZlY3ljbGVCYXNlIGltcGxlbWVudHMgTGlmZWN5Y2xlIHtcblx0LUxpZmVjeWNsZVN0YXRlIHN0YXRlXG5cdCtpbml0KClcblx0K3N0YXJ0KClcblx0I2luaXRJbnRlcm5hbCgpXG5cdCNzdGFydEludGVybmFsKClcbn1cblxuZW51bSBMaWZlY3ljbGVTdGF0ZSB7XG5cdE5FVyhmYWxzZSwgbnVsbClcblx0SU5JVElBTElaSU5HKGZhbHNlLCBMaWZlY3ljbGUuQkVGT1JFX0lOSVRfRVZFTlQpXG5cdFNUQVJUSU5HKHRydWUsIExpZmVjeWNsZS5TVEFSVF9FVkVOVClcbiAgU1RBUlRFRCh0cnVlLCBMaWZlY3ljbGUuQUZURVJfU1RBUlRfRVZFTlQpXG59XG5cbmFic3RyYWN0IGNsYXNzIExpZmVjeWNsZU1CZWFuQmFzZSBleHRlbmRzIExpZmVjeWNsZUJhc2V7XG5cdCtpbml0SW50ZXJuYWwoKVxufVxuXG5pbnRlcmZhY2UgU2VydmVyIGV4dGVuZHMgTGlmZWN5Y2xle1xuXHQrU2VydmljZVtdIGZpbmRTZXJ2aWNlcygpXG59XG5cbmNsYXNzIFN0YW5kYXJkU2VydmVyIGV4dGVuZHMgTGlmZWN5Y2xlTUJlYW5CYXNlIGltcGxlbWVudHMgU2VydmVyIHtcbiAgK1NlcnZpY2VbXSBzZXJ2aWNlc1xuXHQraW5pdEludGVybmFsKClcblx0K3N0YXJ0SW50ZXJuYWwoKVxufVxuXG5pbnRlcmZhY2UgU2VydmljZSBpbXBsZW1lbnRzIExpZmVjeWNsZSB7XG5cdCtFbmdpbmUgZ2V0Q29udGFpbmVyKClcblx0K3NldENvbnRhaW5lcihFbmdpbmUpXG59XG5cbmNsYXNzIFN0YW5kYXJkU2VydmljZSBleHRlbmRzIExpZmVjeWNsZU1CZWFuQmFzZSBpbXBsZW1lbnRzIFNlcnZpY2V7XG5cdCtDb25uZWN0b3JbXSBjb25uZWN0b3JzXG5cdCtFbmdpbmUgZW5naW5lXG5cdCtpbml0SW50ZXJuYWwoKVxuXHQrc3RhcnRJbnRlcm5hbCgpXG59XG5cbmludGVyZmFjZSBDb250YWluZXIgZXh0ZW5kcyBMaWZlY3ljbGV7XG5cdCtQaXBlbGluZSBnZXRQaXBlbGluZSgpXG59XG5cbmFic3RyYWN0IGNsYXNzIENvbnRhaW5lckJhc2UgZXh0ZW5kcyBMaWZlY3ljbGVNQmVhbkJhc2UgaW1wbGVtZW50cyBDb250YWluZXJ7XG5cdCNQaXBlbGluZSBwaXBlbGluZVxuXHQrQ29udGFpbmVyW10gZmluZENoaWxkcmVuKClcblx0I2luaXRJbnRlcm5hbCgpXG5cdCNzdGFydEludGVybmFsKClcbn1cblxuaW50ZXJmYWNlIFBpcGVsaW5lIHtcblx0K1ZhbHZlIGdldEJhc2ljKClcblx0K3ZvaWQgc2V0QmFzaWMoVmFsdmUgdmFsdmUpXG5cdCt2b2lkIGFkZFZhbHZlKFZhbHZlIHZhbHZlKVxufVxuXG5pbnRlcmZhY2UgVmFsdmUge1xuXHQrVmFsdmUgZ2V0TmV4dCgpXG5cdCt2b2lkIHNldE5leHQoVmFsdmUpXG5cdCt2b2lkIGludm9rZShSZXF1ZXN0LFJlc3BvbnNlKVxufVxuXG5pbnRlcmZhY2UgRW5naW5lIGV4dGVuZHMgQ29udGFpbmVyIHtcblx0K3NldERlZmF1bHRIb3N0KFN0cmluZyBkZWZhdWx0SG9zdClcblx0K1NlcnZpY2UgZ2V0U2VydmljZSgpXG59XG5cbmNsYXNzIFN0YW5kYXJkRW5naW5lIGV4dGVuZHMgQ29udGFpbmVyQmFzZSBpbXBsZW1lbnRzIEVuZ2luZXtcblx0I2luaXRJbnRlcm5hbCgpXG5cdCNzdGFydEludGVybmFsKClcbn1cblxuaW50ZXJmYWNlIENvbnRleHQgZXh0ZW5kcyBDb250YWluZXJ7XG5cdCtTdHJpbmcgZ2V0RG9jQmFzZSgpXG5cdCtMb2FkZXIgZ2V0TG9hZGVyKClcblx0K1dlYlJlc291cmNlUm9vdCBnZXRSZXNvdXJjZXMoKVxufVxuXG5jbGFzcyBTdGFuZGFyZENvbnRleHQgZXh0ZW5kcyBDb250YWluZXJCYXNlIGltcGxlbWVudHMgQ29udGV4dHtcblx0LS3mnoTpgKDmlrnms5Xkvb_nlKjkuoZQaXBlbGluZe-8jOWunumZheeci-S7o-eggeW-iOmHjeimgVxuXHQrU3RhbmRhcmRDb250ZXh0KClcblx0I3N0YXJ0SW50ZXJuYWwoKVxuXHQrc2V0TG9hZGVyKExvYWRlciBsb2FkZXIpXG5cdCtib29sZWFuIGZpbHRlclN0YXJ0KClcblx0K2Jvb2xlYW4gbGlzdGVuZXJTdGFydCgpXG5cdCtib29sZWFuIGxvYWRPblN0YXJ0dXAoKVxufVxuXG5pbnRlcmZhY2UgSG9zdCBleHRlbmRzIENvbnRhaW5lciB7XG5cdCtTdHJpbmcgZ2V0QXBwQmFzZSgpXG5cdCtib29sZWFuIGdldEF1dG9EZXBsb3koKVxufVxuXG5jbGFzcyBTdGFuZGFyZEhvc3QgZXh0ZW5kcyBDb250YWluZXJCYXNlIGltcGxlbWVudHMgSG9zdCB7XG5cdCt2b2lkIHN0YXJ0SW50ZXJuYWwoKVx0XG59XG5cbmFic3RyYWN0IGNsYXNzIFZhbHZlQmFzZSBleHRlbmRzIExpZmVjeWNsZU1CZWFuQmFzZSBpbXBsZW1lbnRzIENvbnRhaW5lZCwgVmFsdmV7XG5cdCt2b2lkIGluaXRJbnRlcm5hbCgpXG5cdCt2b2lkIHN0YXJ0SW50ZXJuYWwoKVxuXHRDb250YWluZXIgZ2V0Q29udGFpbmVyKClcbn1cblxuY2xhc3MgU3RhbmRhcmRDb250ZXh0VmFsdmUgZXh0ZW5kcyBWYWx2ZUJhc2V7XG5cdHZvaWQgaW52b2tlKFJlcXVlc3QsUmVzcG9uc2UpXG59XG5cbmludGVyZmFjZSBDb250YWluZWQge1xuXHQrQ29udGFpbmVyIGdldENvbnRhaW5lcigpXG5cdCtzZXRDb250YWluZXIoQ29udGFpbmVyKVxufVxuXG5jbGFzcyBTdGFuZGFyZEhvc3RWYWx2ZSBleHRlbmRzIFZhbHZlQmFzZSB7XG5cdCtpbnZva2UoUmVxdWVzdCwgUmVzcG9uc2UpXG5cdC1zdGF0dXMoUmVxdWVzdCwgUmVzcG9uc2UpXG59XG5cbmNsYXNzIFN0YW5kYXJkUGlwZWxpbmUgZXh0ZW5kcyBMaWZlY3ljbGVCYXNlIGltcGxlbWVudHMgUGlwZWxpbmUsIENvbnRhaW5lZCB7XG4gXHQrc2V0Q29udGFpbmVyKENvbnRhaW5lcilcblx0K3N0YXJ0SW50ZXJuYWwoKTtcbn1cblxuY2xhc3MgQ29ubmVjdG9yIGV4dGVuZHMgTGlmZWN5Y2xlTUJlYW5CYXNlIHtcblx0K1Byb3RvY29sSGFuZGxlciBwcm90b2NvbEhhbmRsZXJcbn1cblxuTGlmZWN5Y2xlQmFzZSAtLSBMaWZlY3ljbGVTdGF0ZVxuVmFsdmUgKi1kb3duLSBQaXBlbGluZVxuQ29ubmVjdG9yICotZG93bi0gU3RhbmRhcmRTZXJ2aWNlXG5Db250YWluZXIgLS0gUGlwZWxpbmVcbkBlbmR1bWwiLCJ0eXBlIjoicHVtbCIsImlkIjoicVR3Z08iLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sL2Y0NGVhYjFlMzRiNGZhMTNlNmVlMjRhNDliMTQ2Y2ExLnN2ZyIsImhlaWdodCI6MzI0LCJjYXJkIjoiZGlhZ3JhbSJ9)**
> **语雀画UML图还在探索中，这里依赖关系就没有画出来了，简单点就是 **
> **
> **Server-->Service-->Engine-->Context**


这个类图是使用 [语雀 ](https://www.yuque.com/)画的，肯定没有自动生成的好看，但是比起自动生成，体会更深刻一些，有兴趣到同学可以自行画一下，这里稍微有些乱，简单讲解一下

这里所有的**class**基本上都实现了或者是间接实现了 **Lifecycle 接口，**主要入口是 **Server(StandardServer).**他们都继承了**LifecycleBase，**初始化和启动会去执行对应的 init 和 start 方法，如果debug会多次进入这里，第一次会稍微有点乱，需要理解各个Class之间的依赖关系。

通过Lifecycle作为纽带，以及Class之间的依赖关系，Tomcat启动的时候可以一级一级的启动所有的Service和Engine(容器)等子类

### 简单描述

开始是Server.init，一级一级的传递给所有依赖的Class，对应都会去执行init，然后是start，start的流程和init是一致的。

当Server.start 启动时，先启动内部的Service.start, Service 先启动下一级的Connector和Engine，Engine启动Context(这里是启动一个异步线程处理)

```
startStopExecutor.submit(new StartChild(children[i])); 线程池的名字是 域名-startStop-n
```

Context里边设置Loader(类加载器)，加载ServletContainerInitializer并调用onStartup，执行Listener启动，Filter启动，任意初始化失败都会导致Context启动失败，但是不会影响到Tomcat的正常启动，最后加载Servlet，根据load-start-up>=1来初始化Servlet。到这里基本上就执行完毕了

上面也可以看到**Pipeline， **她的的使用是典型的责任链模式 ， 通过**Pipeline可以将Engine/Host/Context串行联系起来，**他们的纽带是** Valve **接口。使用责任链模式可以快速方便的进行拓展。

## 时序图


![](https://cdn.nlark.com/yuque/__puml/04269a2d8f24155a22d47f8572420203.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbmF1dG9udW1iZXJcblxuYWN0b3IgQ2F0YWxpbmEgXG5wYXJ0aWNpcGFudCBcIlNlcnZlclwiIGFzIFNlcnZlclxucGFydGljaXBhbnQgXCJTZXJ2aWNlXCIgYXMgU2VydmljZVxucGFydGljaXBhbnQgXCJFbmdpbmVcIiBhcyBFbmdpbmVcbnBhcnRpY2lwYW50IFwiQ29udGV4dFwiIGFzIENvbnRleHQgI29yYW5nZVxuXG5hY3RpdmF0ZSBDYXRhbGluYVxuQ2F0YWxpbmEgLT4gU2VydmVyIDogQ2F0YWxpbmEjbG9hZCDliqDovb1TZXJ2ZXIueG1s77yM6LWL5YC8XG5cbmFjdGl2YXRlIFNlcnZlclxuXG5TZXJ2ZXIgLT4gU2VydmljZTogU2VydmVyI2luaXRcblxuYWN0aXZhdGUgU2VydmljZVxuXG5TZXJ2aWNlIC0-IEVuZ2luZTog5Yid5aeL5YyW5ZCv5Yqo57q_56iL5rGgbG9jYWxob3N0LXN0YXJ0U3RvcC1uXG5cbmFjdGl2YXRlIEVuZ2luZVxuXG5FbmdpbmUgLT4gU2VydmljZTog5Yid5aeL5YyW5a6M5q-VXG5ub3RlIHJpZ2h0IG9mIFNlcnZlcjog5Yid5aeL5YyW55qE6L-H56iL5Lya5pu06ZqP54q25oCB55qE5Y-Y5pu0XG5cblNlcnZpY2UgLT4gU2VydmVyOiDliJ3lp4vljJblrozmr5VcblxuYWN0aXZhdGUgU2VydmVyXG5TZXJ2ZXIgLT4gU2VydmljZTogc2VydmVyLnN0YXJ0IOWGhemDqOWQr-WKqO-8jOS4u-imgeaYr3N0YXJ0SW50ZXJuYWzvvIzkvJrlvqrnjq_miafooYxzZXJ2aWNlcy5zdGFydFxuXG5hY3RpdmF0ZSBTZXJ2aWNlXG5TZXJ2aWNlIC0-IEVuZ2luZTog5omn6KGMZW5naW5l5ZKMbuS4qmNvbm5lcnRvcueahHN0YXJ0XG5cbmFjdGl2YXRlIEVuZ2luZVxuRW5naW5lIC0-IENvbnRleHQ6IEZ1dHVyZeW8guatpeaJp-ihjO-8jOacquaJp-ihjOWujOavleS8mumYu-WhnlxuXG5hY3RpdmF0ZSBDb250ZXh0XG5Db250ZXh0IC0-IEVuZ2luZTog5omn6KGMbGlzdGVuZXIvZmlsdGVyL1NlcnZsZXTliJ3lp4vljJZcbm5vdGUgcmlnaHQgb2YgQ29udGV4dDog5YW35L2T55qE5rWB56iL5Zyo5LiK6L655o-P6L-wXG5cbmFjdGl2YXRlIEVuZ2luZVxuRW5naW5lIC0-IFNlcnZpY2U6IOaJp-ihjHN0YXJ05a6M5q-VXG5cbmFjdGl2YXRlIFNlcnZpY2VcblNlcnZpY2UgLT4gU2VydmVyOiDlh7rnjrDml6Xlv5cgU2VydmVyIHN0YXJ0dXAgaW4gMjAwMDMgbXNcbm5vdGUgcmlnaHQgb2YgU2VydmVyOiDmiZPlvIDkuIDkuKrnm5HlkKznq6_lj6PvvIznm5HlkKxTSFVURE9XTuWRveS7pOWQjuWFs-mXrVRPTUNBVCzlvIDlp4vmiafooYxTZXJ2ZXIuc3RvcFxuXG5kZWFjdGl2YXRlIFNlcnZlclxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJpZCI6ImxDQXJmIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC8wNDI2OWEyZDhmMjQxNTVhMjJkNDdmODU3MjQyMDIwMy5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9)
大体上是这样的，具体的细节就需要看代码了

## 总结
Tomcat的启动初看比较复杂，但是在理解他们的Class引用关系后，就会变的简单很多，类的继承关系也很复杂，但是我可以抓住她运行时的核心类 LifecycleBase和ContainerBase 会好理解一点。

如果文章描述不当或者是有疑问的可以通过邮箱找 chenshun00@gmail.com
